{% extends "base.html" %}

{% block title %}Course Details{% endblock %}

{% block extra_styles %}
.lesson-item {
    cursor: pointer;
}

.lesson-item.completed {
    border-left: 4px solid #28a745;
}

.lesson-item:active {
    transform: scale(0.98);
}
{% endblock %}

{% block content %}
<div class="header">
    <h1 id="course-title">Loading...</h1>
    <p id="course-description"></p>
</div>

<div class="card" style="background: #fff3cd;">
    <button class="btn btn-warning" onclick="reviewDueWords()">
        üîÑ Review Due Words (<span id="due-words-count">0</span>)
    </button>
    <p style="margin-top: 12px; font-size: 13px; color: #856404;">
        Practice words from previous lessons that need reinforcement
    </p>
</div>

<h2 style="margin: 24px 0 16px 0;">üìñ Lessons</h2>

<a href="/courses/{{ course_id }}/lessons/create" id="create-lesson-btn" class="btn" style="background: #28a745; margin-bottom: 16px;">
    ‚ûï Create New Lesson
</a>

<div id="lessons-list">
    <div style="text-align: center; padding: 40px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 16px;">Loading lessons...</p>
    </div>
</div>

<a href="/courses" class="btn btn-secondary">‚Üê Back to Courses</a>
{% endblock %}

{% block scripts %}
const courseId = {{ course_id }};

async function loadCourseData() {
    try {
        // Load course info
        const courseResponse = await fetch(`/api/v1/courses/${courseId}`, {
            headers: createAuthHeaders()
        });

        if (!courseResponse.ok) {
            throw new Error('Failed to load course');
        }

        const course = await courseResponse.json();
        document.getElementById('course-title').textContent = course.title;
        document.getElementById('course-description').textContent = course.description || '';

        const lessons = course.lessons;
        const lessonsList = document.getElementById('lessons-list');

        if (lessons.length === 0) {
            lessonsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìñ</div>
                    <h3>No lessons yet</h3>
                    <p>Add lessons through the API to start learning</p>
                </div>
            `;
        } else {
            // Display lessons first (without waiting for progress)
            lessonsList.innerHTML = lessons.map(lesson => `
                <a href="/lessons/${lesson.id}"
                   class="card-link"
                   style="text-decoration: none; color: inherit; cursor: pointer;"
                   data-lesson-id="${lesson.id}"
                >
                <div class="card lesson-item">
                    <h3>
                        ${lesson.title}
                        <span class="lesson-status-${lesson.id}"></span>
                    </h3>
                    <p style="margin: 8px 0; color: var(--tg-theme-hint-color, #666);">
                        ${lesson.description || 'No description'}
                    </p>
                    <p style="font-size: 14px; color: var(--tg-theme-hint-color, #666);">
                        Lesson ${lesson.order_index} ‚Ä¢ <span class="lesson-progress-${lesson.id}">Loading...</span>
                    </p>
                    <div class="lesson-progress-bar-${lesson.id}"></div>
                </div>
                </a>
            `).join('');

            // Load progress for each lesson asynchronously
            lessons.forEach(async lesson => {
                try {
                    const progressResponse = await fetch(`/api/v1/reviews/progress/lesson/${lesson.id}`, {
                        headers: createAuthHeaders()
                    });

                    if (progressResponse.ok) {
                        const progress = await progressResponse.json();
                        const isCompleted = progress.is_completed || false;
                        const progressPercentage = progress.progress_percentage || 0;
                        const wordsLearned = progress.words_learned || 0;
                        const totalWords = progress.total_words || 0;

                        // Update status badge
                        const statusElement = document.querySelector(`.lesson-status-${lesson.id}`);
                        if (statusElement && isCompleted) {
                            statusElement.innerHTML = '<span class="badge badge-success">‚úì Completed</span>';
                            // Add completed class to card
                            const card = document.querySelector(`[data-lesson-id="${lesson.id}"]`);
                            if (card) card.classList.add('completed');
                        }

                        // Update progress text
                        const progressTextElement = document.querySelector(`.lesson-progress-${lesson.id}`);
                        if (progressTextElement) {
                            progressTextElement.textContent = `${wordsLearned}/${totalWords} words learned`;
                        }

                        // Update progress bar
                        const progressBarElement = document.querySelector(`.lesson-progress-bar-${lesson.id}`);
                        if (progressBarElement && progressPercentage > 0) {
                            progressBarElement.innerHTML = `
                                <div class="progress-bar" style="margin-top: 8px;">
                                    <div class="progress-fill" style="width: ${progressPercentage}%;"></div>
                                </div>
                            `;
                        }
                    } else {
                        // No progress yet - show 0/total
                        const progressTextElement = document.querySelector(`.lesson-progress-${lesson.id}`);
                        if (progressTextElement) {
                            progressTextElement.textContent = `0/${lesson.words?.length || 0} words learned`;
                        }
                    }
                } catch (error) {
                    console.error(`Error loading progress for lesson ${lesson.id}:`, error);
                    // Show default state on error
                    const progressTextElement = document.querySelector(`.lesson-progress-${lesson.id}`);
                    if (progressTextElement) {
                        progressTextElement.textContent = 'Not started';
                    }
                }
            });

            // Add haptic feedback
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.addEventListener('click', () => {
                    tg.HapticFeedback.impactOccurred('light');
                });
            });
        }
    } catch (error) {
        console.error('Error loading course data:', error);
        tg.showAlert('Failed to load course data. Please try again.');
    }
}

async function reviewDueWords() {
    // TODO: update review session handling
    try {
        const response = await fetch('/api/v1/reviews/due?limit=20', {
            headers: createAuthHeaders()
        });

        if (response.ok) {
            const dueWords = await response.json();
            if (dueWords.length === 0) {
                tg.showAlert('No words due for review right now!');
            } else {
                tg.showAlert('Review session coming soon!');
            }
        }
    } catch (error) {
        console.error('Error loading due words:', error);
        tg.showAlert('Failed to load due words');
    }
}

// Load data on page load
loadCourseData();
{% endblock %}

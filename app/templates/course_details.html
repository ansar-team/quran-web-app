{% extends "base.html" %}

{% block title %}Course Details{% endblock %}

{% block extra_styles %}
.lesson-item {
    cursor: pointer;
}

.lesson-item.completed {
    border-left: 4px solid #28a745;
}

.lesson-item:active {
    transform: scale(0.98);
}
{% endblock %}

{% block content %}
<div class="header">
    <h1 id="course-title"></h1>
    <p id="course-description"></p>
</div>

<div class="card" style="background:#fff3cd;">
    <button class="btn btn-warning" onclick="reviewDueWords()">
        ğŸ”„ {{ i18n.course_page.btn_review }}
        (<span id="due-words-count">0</span>)
    </button>
    <p style="margin-top:12px; font-size:13px; color:#856404;">
        {{ i18n.course_page.desc_review }}
    </p>
</div>

<h2 style="margin: 24px 0 16px;">ğŸ“– {{ i18n.course_page.title }}</h2>

<a href="/courses/{{ course_id }}/lessons/create" id="create-lesson-btn" class="btn" style="background: #28a745; margin-bottom: 16px;">
    â• {{ i18n.course_page.btn_create }}
</a>

<div id="lessons-list">
    <div id="lessons-loading" style="text-align: center; padding: 40px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 16px;">{{ i18n.course_page.loading }}...</p>
    </div>
    <div id="empty-card" class="empty-state" style="display:none;">
        <div class="empty-icon">ğŸ“–</div>
        <h3>{{ i18n.course_page.e_title }}</h3>
        <p>{{ i18n.course_page.e_desc }}</p>
    </div>
</div>

<a href="/courses" class="btn btn-secondary" style="margin-bottom: 58px">â† {{ i18n.course_page.btn_back }}</a>
{% endblock %}

{% block scripts %}
const courseId = {{ course_id }};

async function loadCourseData() {
    try {
        const courseResponse = await fetch(`/api/v1/courses/${courseId}`);

        if (!courseResponse.ok) {
            throw new Error('Failed to load course');
        }

        const course = await courseResponse.json();
        document.getElementById('course-title').textContent = course.title;
        document.getElementById('course-description').textContent = course.description || '';

        const lessons = course.lessons;

        try {
            fetch('/api/v1/reviews/due?limit=20')
            .then(r => r.ok ? r.json() : null)
            .then(d => {
                if (d) document.getElementById('due-words-count').textContent = d.words.length;
            });

            if (lessons.length === 0) {
                document.getElementById('lessons-empty').style.display = 'block';
                return;
            }
        } catch (error) {
            console.error('Error loading due words count:', error);
        }

        document.getElementById('lessons-loading').style.display = 'none';

        const lessonsList = document.getElementById('lessons-list');

        if (lessons.length === 0) {
            document.getElementById('empty-card').style.display = "block";
        } else {
            lessonsList.innerHTML = lessons.map(lesson => `
                <a href="/lessons/${lesson.id}"
                   class="card-link"
                   style="text-decoration: none; color: inherit; cursor: pointer;"
                   data-lesson-id="${lesson.id}"
                >
                <div class="card lesson-item">
                    <h3>
                        ${lesson.title}
                        <span id="status-${lesson.id}" class="lesson-status"></span>
                    </h3>
                    <p style="margin: 8px 0; color: var(--tg-theme-hint-color, #5e5e5e);">
                        ${lesson.description || ""}
                    </p>
                    <p style="font-size: 14px; color: var(--tg-theme-hint-color, #5e5e5e);">
                        #ï¸âƒ£ ${lesson.order_index} â€¢
                        <span id="progress-text-${lesson.id}" class="lesson-progress">ğŸŒ€...</span>
                    </p>
                    <div id="progress-bar-${lesson.id}" class="lesson-progress-bar"></div>
                </div>
                </a>
            `).join('');

            lessons.forEach(async lesson => {
                try {
                    const progressResponse = await fetch(`/api/v1/reviews/progress/lesson/${lesson.id}`);

                    if (!progressResponse.ok) {
                        throw new Error();
                    }

                    const progress = await progressResponse.json();
                    const progressPercentage = progress.progress_percentage || 0;

                    if (progress.is_completed) {
                        document.getElementById(`status-${lesson.id}`).innerHTML = 'âœ…';
                        document.querySelector(`[data-lesson-id="${lesson.id}"]`).classList.add('completed');
                    }

                    document.getElementById(`progress-text-${lesson.id}`)
                        .textContent = `${progress.words_learned || 0}/${progress.total_words || 0} ğŸ¤“`;


                    if (progressPercentage > 0) {
                        document.getElementById(`progress-bar-${lesson.id}`).innerHTML = `
                            <div class="progress-bar" style="margin-top:8px;">
                                <div class="progress-fill" style="width: ${progressPercentage}%;"></div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`Error loading progress for lesson ${lesson.id}:`, error);
                    document.getElementById(`progress-text-${lesson.id}`)
                        .textContent = 'Not started';
                }
            });

            // Add haptic feedback
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.addEventListener('click', () => {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                });
            });
        }
    } catch (error) {
        console.error('Error loading course data:', error);
        window.Telegram.WebApp.showAlert('Failed to load course.');
    }
}

async function reviewDueWords() {
    location.href = '/review/due';
}

loadCourseData();
{% endblock %}

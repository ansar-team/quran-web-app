{% extends "base.html" %}

{% block title %}
{% if not lesson_id %}
    {{ i18n.completion.practice_title }}
{% else %}
    {{ i18n.completion.lesson_title }}
{% endif %}
{% endblock %}

{% block content %}
<div class="header">
    <h1>ðŸŽ‰
        {% if not lesson_id %}
            {{ i18n.completion.practice_title }}
        {% else %}
            {{ i18n.completion.lesson_title }}
        {% endif %}
    </h1>
    <p>
        {% if not lesson_id %}
            {{ i18n.completion.practice_description }}
        {% else %}
            {{ i18n.completion.lesson_description }}
        {% endif %}
    </p>
</div>

<div class="card" style="background: #d4edda; border: 2px solid #28a745;">
    <h2 style="color: #155724; margin-bottom: 16px;">
        {{ i18n.completion.excellent_progress }}
    </h2>
    <p style="color: #155724;">
        {{ i18n.completion.completed_prefix }}
        <strong id="completed-lesson-title">
            {% if not lesson_id %}
                {{ i18n.completion.practice_name }}
            {% else %}
                {{ i18n.completion.lesson_name }}
            {% endif %}
        </strong>
    </p>
</div>

<div class="stats-grid" id="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="words-studied">0</div>
        <div class="stat-label">{{ i18n.completion.words_studied }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="words-learned">0</div>
        <div class="stat-label">{{ i18n.completion.words_learned }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="streak-count">1</div>
        <div class="stat-label">{{ i18n.completion.day_streak }}</div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 12px;">
        ðŸŽ¯ {{ i18n.completion.whats_next }}
    </h3>
    <p style="margin-bottom: 16px; color: var(--tg-theme-hint-color, #666);">
        {{ i18n.completion.hard_words_hint }}
    </p>
</div>

<!--TODO: add functionality to those buttons -->
<a href="#" id="continue-btn" class="btn">
    {{ i18n.completion.continue_next_lesson }}
</a>

<a href="/lessons/{{ lesson_id }}" class="btn btn-secondary">
    {{ i18n.completion.review_lesson }}
</a>

<a href="/courses" class="btn btn-secondary">
    ðŸ“š {{ i18n.completion.all_courses }}
</a>
{% endblock %}

{% block scripts %}
const lessonId = {{ lesson_id if lesson_id else 'null' }};

async function loadCompletionData() {
    try {
        await updateStreak();

        if (lessonId) {
            const lessonResponse = await fetch(`/api/v1/lessons/${lessonId}`);

            if (!lessonResponse.ok) {
                throw new Error('Failed to load lesson');
            }

            const lesson = await lessonResponse.json();
            document.getElementById('completed-lesson-title').textContent = lesson.title;
            document.getElementById('continue-btn').href = `/courses/${lesson.course_id}`;

            // Load lesson progress to get accurate stats
            const progressResponse = await fetch(`/api/v1/reviews/progress/lesson/${lessonId}`});

            if (progressResponse.ok) {
                const progress = await progressResponse.json();
                document.getElementById('words-studied').textContent = progress.total_words;
                document.getElementById('words-learned').textContent = progress.words_learned;
            }
        } else {
            // For repetition, you might want to load different stats
            // document.getElementById('words-learned').textContent = '8';
            document.getElementById('stats-grid').style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading completion data:', error);
    }
}

async function updateStreak() {
    try {
        const response = await fetch('/api/v1/reviews/streak', {
            method: 'POST',
        });

        if (!response.ok) {
            console.error('Failed to update streak');
        }

        if (response.ok) {
            const streakData = await response.json();
            document.getElementById('streak-count').textContent = streakData.current_streak;
        }
    } catch (error) {
        console.error('Error updating streak:', error);
    }
}

// Celebrate!
tg.HapticFeedback.notificationOccurred('success');

// Load data
loadCompletionData();
{% endblock %}

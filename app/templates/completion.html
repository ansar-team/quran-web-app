{% extends "base.html" %}

{% block title %}{% if not lesson_id %}Practice Complete!{% else %}Lesson Complete!{% endif %}{% endblock %}

{% block content %}
<div class="header">
    <h1>ðŸŽ‰ {% if not lesson_id %}Practice Complete!{% else %}Lesson Complete!{% endif %}</h1>
    <p>Great job! You've mastered {% if not lesson_id %}this practice session{% else %}this lesson{% endif %}.</p>
</div>

<div class="card" style="background: #d4edda; border: 2px solid #28a745;">
    <h2 style="color: #155724; margin-bottom: 16px;">Excellent Progress!</h2>
    <p style="color: #155724;">
        You've successfully completed <strong id="completed-lesson-title">
            {% if not lesson_id %}word repetition practice{% else %}this lesson{% endif %}
        </strong>
    </p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="words-studied">0</div>
        <div class="stat-label">Words Studied</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="words-learned">0</div>
        <div class="stat-label">Words Learned</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="streak-count">1</div>
        <div class="stat-label">Day Streak</div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 12px;">ðŸŽ¯ What's Next?</h3>
    <p style="margin-bottom: 16px; color: var(--tg-theme-hint-color, #666);">
        Words you rated as "Hard" will appear more frequently in review sessions to strengthen your memory.
    </p>
</div>
<!--TODO: add functionality to those buttons -->
<a href="#" id="continue-btn" class="btn">
    Continue to Next Lesson
</a>
<a href="/lessons/{{ lesson_id }}" class="btn btn-secondary">
    Review This Lesson Again
</a>
<a href="/courses" class="btn btn-secondary">
    ðŸ“š All Courses
</a>
{% endblock %}

{% block scripts %}
const lessonId = {{ lesson_id if lesson_id else 'null' }};

async function loadCompletionData() {
    try {
        await updateStreak();

        if (lessonId) {
            const lessonResponse = await fetch(`/api/v1/lessons/${lessonId}`, {
                headers: createAuthHeaders()
            });

            if (!lessonResponse.ok) {
                throw new Error('Failed to load lesson');
            }

            const lesson = await lessonResponse.json();
            document.getElementById('completed-lesson-title').textContent = lesson.title;
            document.getElementById('continue-btn').href = `/courses/${lesson.course_id}`;

            // Load lesson progress to get accurate stats
            const progressResponse = await fetch(`/api/v1/reviews/progress/lesson/${lessonId}`, {
                headers: createAuthHeaders()
            });

            if (progressResponse.ok) {
                const progress = await progressResponse.json();
                document.getElementById('words-studied').textContent = progress.total_words;
                document.getElementById('words-learned').textContent = progress.words_learned;
            }
        } else {
            // For repetition, you might want to load different stats
            // document.getElementById('words-learned').textContent = '8';
            document.getElementById('stats-grid').style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading completion data:', error);
    }
}

async function updateStreak() {
    try {
        const response = await fetch('/api/v1/reviews/streak', {
            method: 'POST',
            headers: createAuthHeaders()
        });

        if (!response.ok) {
            console.error('Failed to update streak');
        }

        if (response.ok) {
            const streakData = await response.json();
            document.getElementById('streak-count').textContent = streakData.current_streak;
        }
    } catch (error) {
        console.error('Error updating streak:', error);
    }
}

// Celebrate!
tg.HapticFeedback.notificationOccurred('success');

// Load data
loadCompletionData();
{% endblock %}
